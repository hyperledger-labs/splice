# Copyright (c) 2024 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

suite: "Mediator values"
templates:
  - mediator.yaml
release:
  # Set for testing labels
  name: global-domain-6
chart:
  # Override for testing labels
  version: 0.1.1
  appVersion: 0.1.0
tests:
  - it: "sets labels as expected"
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      # Sanity checks
      - equal:
          path: metadata.name
          value: global-domain-6-mediator
      - equal:
          path: spec.template.spec.containers[0].name
          value: mediator
      # Labels on deployment
      - isSubset:
          path: metadata.labels
          content:
            # Splice-specific
            app: global-domain-6-mediator
            splice-component: mediator
            # k8s/Helm standard
            app.kubernetes.io/component: mediator
            app.kubernetes.io/instance: global-domain-6
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: global-domain-6-mediator
            app.kubernetes.io/version: "0.1.0"
            helm.sh/chart: splice-global-domain-0.1.1
      # Labels on pod; should be the same as on deployment
      - isSubset:
          path: spec.template.metadata.labels
          content:
            # Splice-specific
            app: global-domain-6-mediator
            splice-component: mediator
            # k8s/Helm standard
            app.kubernetes.io/component: mediator
            app.kubernetes.io/instance: global-domain-6
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: global-domain-6-mediator
            app.kubernetes.io/version: "0.1.0"
            helm.sh/chart: splice-global-domain-0.1.1
  - it: "can enable pvc"
    set:
      pvc:
        size: 10Gi
        volumeStorageClass: standard-rwo
    documentSelector:
      path: kind
      value: PersistentVolumeClaim
    asserts:
      - equal:
          path: metadata.name
          value: global-domain-6-mediator-pvc
  - it: "can set additional env vars"
    set:
      mediator:
        additionalEnvVars:
        - name: ADDITIONAL_MEDIATOR_ENV_VAR_NAME
          value: ADDITIONAL_MEDIATOR_ENV_VAR_VALUE
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ADDITIONAL_MEDIATOR_ENV_VAR_NAME
            value: ADDITIONAL_MEDIATOR_ENV_VAR_VALUE
  - it: "uses resources when only resources is set"
    set:
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 200m
          memory: 256Mi
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
  - it: "uses mediator.resources when only mediator.resources is set"
    set:
      mediator:
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
  - it: "merges resources with mediator.resources taking precedence"
    set:
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 200m
          memory: 256Mi
      mediator:
        resources:
          requests:
            cpu: 500m
          limits:
            memory: 1Gi
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            requests:
              cpu: 500m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 1Gi
  - it: "uses top-level affinity when set and mediator.affinity is not set"
    set:
      affinity:
        nodeAffinity:
          topLevel: true
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - exists:
          path: spec.template.spec.affinity.nodeAffinity.topLevel
  - it: "uses mediator.affinity when set (component-specific overrides top-level)"
    set:
      affinity:
        nodeAffinity:
          topLevelOnly: true
      mediator:
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
                - matchExpressions:
                    - key: workload-type
                      operator: In
                      values:
                        - mediator
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key
          value: workload-type
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].values[0]
          value: mediator
      - notExists:
          path: spec.template.spec.affinity.nodeAffinity.topLevelOnly
