# Copyright (c) 2024 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

suite: "Validator values"
templates:
  - validator.yaml
release:
  # Set for testing labels
  name: mock-validator
chart:
  # Override for testing labels
  version: 0.1.1
  appVersion: 0.1.0

set:
  # Things we need just to pass the schema
  nodeIdentifier: "helm-mock-1-validator"
  validatorPartyHint: "helm-mock-1"
  validatorWalletUser: "mock-wallet-user-id"
  spliceInstanceNames:
    networkName: MockNet
    networkFaviconUrl: https://mock.net/favicon.ico
    amuletName: Mocklet
    amuletNameAcronym: MCK
    nameServiceName: Mock Name Service
    nameServiceNameAcronym: MNS
  topup:
    enabled: false
  auth:
    jwksUrl: "https://mock.com/.well-known/jwks.json"
    audience: "mock_audience"

tests:
  - it: "sets labels and annotations as expected"
    set:
      pod:
        labels:
          mock: yes-please
        annotations:
          mock-annotation: still-an-annotation
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      # Sanity check
      - equal:
          path: spec.template.spec.containers[0].name
          value: validator-app
      # Labels on deployment
      - isSubset:
          path: metadata.labels
          content:
            # Splice-specific
            app: validator-app
            migration: "0"
            # k8s/Helm standard
            app.kubernetes.io/instance: mock-validator
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: validator-app
            app.kubernetes.io/version: "0.1.0"
            helm.sh/chart: splice-validator-0.1.1
            # Extra for test
            mock: yes-please
      # Labels on pod; should be the same as on deployment
      - isSubset:
          path: spec.template.metadata.labels
          content:
            # Splice-specific
            app: validator-app
            migration: "0"
            # k8s/Helm standard
            app.kubernetes.io/instance: mock-validator
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: validator-app
            app.kubernetes.io/version: "0.1.0"
            helm.sh/chart: splice-validator-0.1.1
            # Extra for test
            mock: yes-please
      # Annotations on pod
      - equal:
          path: spec.template.metadata.annotations
          value:
            mock-annotation: still-an-annotation

  - it: "always populates enable-wallet"
    set:
      enableWallet: false
      migration:
        migrating: true
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_ENABLE_WALLET')].value
          value: |
            canton.validator-apps.validator_backend.enable-wallet = "false"

  - it: "sets JWKS timeouts"
    set:
      auth:
        jwks:
          connectionTimeout: "33s"
          readTimeout: "44s"
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='SPLICE_APP_VALIDATOR_AUTH_JWKS_CONNECTION_TIMEOUT')].value
          value: "33s"
      - equal:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='SPLICE_APP_VALIDATOR_AUTH_JWKS_READ_TIMEOUT')].value
          value: "44s"

  - it: "supports disabling auth"
    set:
      disableAuth: true
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='SPLICE_APP_VALIDATOR_LEDGER_API_AUTH_USER_NAME')].value
          value: ledger-api-user
      - exists:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_DISABLE_AUTH')].value

  - it: "configures scan-client for trust-single mode"
    set:
      scanClient:
        scanType: "trust-single"
        scanAddress: "https://single.scan.url:5003"
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_BFT_SCAN')].value
          pattern: "canton.validator-apps.validator_backend.scan-client.type = \"trust-single\""
      - matchRegex:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_BFT_SCAN')].value
          pattern: 'canton.validator-apps.validator_backend.scan-client.url = "https://single.scan.url:5003"'

  - it: "configures scan-client for standard bft mode, including multiple seedUrls"
    set:
      scanClient:
        scanType: "bft"
        seedUrls: [ "https://bft-node-1.url:5003", "https://bft-node-2.url:5003" ]
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_BFT_SCAN')].value
          pattern: "canton.validator-apps.validator_backend.scan-client.type = \"bft\""
      - matchRegex:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_BFT_SCAN')].value
          pattern: 'canton.validator-apps.validator_backend.scan-client.seed-urls = \["https://bft-node-1.url:5003","https://bft-node-2.url:5003"\]'

  - it: "configures scan-client for bft-custom mode, including trustedSvs and threshold"
    set:
      scanClient:
        scanType: "bft-custom"
        seedUrls: [ "https://custom-node-A.com", "https://custom-node-B.com" ]
        trustedSvs: [ "custom-sv-1", "custom-sv-2", "custom-sv-3" ]
        threshold: 2
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_BFT_SCAN')].value
          pattern: "canton.validator-apps.validator_backend.scan-client.type = \"bft-custom\""
      - matchRegex:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_BFT_SCAN')].value
          pattern: 'canton.validator-apps.validator_backend.scan-client.seed-urls = \["https://custom-node-A.com","https://custom-node-B.com"\]'
      - matchRegex:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_BFT_SCAN')].value
          pattern: 'canton.validator-apps.validator_backend.scan-client.trusted-svs = \["custom-sv-1","custom-sv-2","custom-sv-3"\]'
      - matchRegex:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_BFT_SCAN')].value
          pattern: "canton.validator-apps.validator_backend.scan-client.threshold = 2"

  - it: "configures scan-client for trust-single when nonSvValidatorTrustSingleScan is true"
    set:
      nonSvValidatorTrustSingleScan: true
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_NON_VALIDATOR_TRUST_SINGLE_SCAN')].value
          pattern: "canton.validator-apps.validator_backend.scan-client.type = \"trust-single\""

  - it: "defaults to BFT scan client with internal scan address if no config is set"
    set:
      svValidator: false
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_BFT_SCAN')].value
          pattern: "canton.validator-apps.validator_backend.scan-client.type = \"bft\""
      - matchRegex:
          path: spec.template.spec.containers[?(@.name=='validator-app')].env[?(@.name=='ADDITIONAL_CONFIG_BFT_SCAN')].value
          pattern: "canton\\.validator-apps\\.validator_backend\\.scan-client\\.seed-urls = \\[\\s*\\$\\{_scan\\.admin-api\\.address\\}\\s*\\]"
