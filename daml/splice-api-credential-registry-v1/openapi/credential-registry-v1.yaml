# Copyright (c) 2025 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

openapi: 3.0.0
info:
  title: Credential registry off-ledger API
  description: |
    Implemented by credential registries for the purpose of creating, updating,
    and querying credential records.
  version: 1.0.0
paths:

  # TODO: fix the schema validation errors. The current state is meant as a sketch to align on the design.

  # TODO: add info endpoint where one can learn about limits of the registry etc.

  # TODO: consider renaming "CredentialRegistry" to "CredentialFactory" to be consistent with the token standard APIs; and to make the call below less confusing
  /registry/credentials/v1/credential-factory:
    post:
      operationId: "getCredentialFactory"
      description: |
        Get the credential factory contract and the choice context for updating credential records.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GetCredentialFactoryRequest"
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CredentialFactoryWithChoiceContext"
        "400":
          $ref: "#/components/responses/400"
        "404":
          $ref: "#/components/responses/404"


  /registry/credentials/v1/credentials:
    get:
      operationId: "listCredentials"
      description: |
        List the credential records matching the provided filters.

        Note that registries MAY decide to limit the number of records returned.
      parameters:
        - in: query
          name: holder
          schema:
            type: string
          required: false
          description: |
            Only return credential records held by the specified party.
        - in: query
          name: issuer
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          required: false
          description: |
            Only return credential records issued by one of the specified issuers.
        - in: query
          name: keyPrefix
          schema:
            type: string
          required: false
          description: |
            Only return credential records that contain a claim with a key that starts with the given prefix.
        - in: query
          name: limit
          schema:
            type: integer
            format: int32
          required: false
          description: |
            The maximum number of credential records to return.
        - in: query
          name: pageToken
          schema:
            type: string
          required: false
          description: |
            The page token to continue retrieving results from a previous list request.
            Ensure that the other filter parameters are identical to the previous request.
        - in: query
          name: validAsOf
          schema:
            type: string
            format: date-time
          required: false
          description: |
            If provided, only return credential records that are valid at the given time.

        - in: query
          name: includeDisclosedContracts
          schema:
            type: boolean
            default: false
          required: false
          description: |
            If set to true, the response will include the disclosed contracts of the credentials
            for use with explicit contract disclosure upon command submission.
        - in: query
          name: excludeDebugFields
          schema:
            type: boolean
            default: false
          required: false
          description: |
            If set to true, then the disclosed contracts will not include debug fields.

    responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListCredentialsResponse"
        "400":
          $ref: "#/components/responses/400"
        "404":
          $ref: "#/components/responses/404"



components:
  responses:
    "400":
      description: "bad request"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    "404":
      description: "not found"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    GetCredentialFactoryRequest:
      type: object
      properties:
        choiceArguments:
          type: object
          description: |
            The arguments that are intended to be passed to the choice provided by the factory.
            To avoid repeating the Daml type definitions, they are specified as JSON objects.
            However the concrete format is given by how the choice arguments are encoded using the Daml JSON API
            (with the `extraArgs.context` and `extraArgs.meta` fields set to the empty object).

            The choice arguments are provided so that the registry can also make choice-argument
            specific decisions, e.g., use different factories for different issuer or holder parties.
        excludeDebugFields:
          description: "If set to true, the response will not include fields prefixed with 'debug'. Useful to save bandwidth."
          default: false
          type: boolean
      required:
        [
          "choiceArguments",
        ]

    CredentialFactoryWithChoiceContext:
      description: |
        The credential factory contract together with the choice context required to exercise the choice
        provided by the factory. Typically used to implement the generic initiation of on-ledger workflows
        via a Daml interface.

        Clients SHOULD avoid reusing the same `CredentialFactoryWithChoiceContext` for exercising multiple choices,
        as the choice context MAY be specific to the choice being exercised.
      type: object
      properties:
        factoryId:
          description: "The contract ID of the contract implementing the factory interface."
          type: string
        choiceContext:
          $ref: "#/components/schemas/ChoiceContext"
      required:
        [
          "factoryId",
          "choiceContext",
          "transferKind",
        ]

    ChoiceContext:
      description: |
        The context required to exercise a choice on a contract via an interface.
        Used to retrieve additional reference data that is passed in via disclosed contracts,
        which are in turn referred to via their contract ID in the `choiceContextData`.
      type: object
      properties:
        choiceContextData:
          description: "The additional data to use when exercising the choice."
          type: object
        disclosedContracts:
          description: |
            The contracts that are required to be disclosed to the participant node for exercising
            the choice.
          type: array
          items:
            $ref: "#/components/schemas/DisclosedContract"
      required:
        [
          "choiceContextData",
          "disclosedContracts",
        ]

    DisclosedContract:
      type: object
      description: |
        A contract that is disclosed for use with explicit contract disclosure
        when preparing transactions on validator nodes that do not know this contract.
      properties:
        templateId:
          type: string
          description: "The template ID of the disclosed contract."
        contractId:
          type: string
          description: "The contract ID of the disclosed contract."
        createdEventBlob:
          type: string
          description: |
            The binary-encoded created event of the disclosed contract.
            This blob can be used to prepare transactions on validator
            nodes that do not know this contract. This is done using
            explicit contract disclosure, where the created event is
            provided alongside the command that refers to the contract.
        synchronizerId:
          description: |
            The synchronizer to which the contract is currently assigned.
            If the contract is in the process of being reassigned, then a "409" response is returned.
          type: string
        debugPackageName:
          description: |
            The name of the Daml package that was used to create the contract.
            Use this data only if you trust the provider, as it might not match the data in the
            `createdEventBlob`.
          type: string
        debugPayload:
          description: |
            The contract arguments that were used to create the contract.
            Use this data only if you trust the provider, as it might not match the data in the
            `createdEventBlob`.
          type: object
        debugCreatedAt:
          description: |
            The ledger effective time at which the contract was created.
            Use this data only if you trust the provider, as it might not match the data in the
            `disclosedContract`.
          type: string
          format: date-time
      required:
        [
          "templateId",
          "contractId",
          "createdEventBlob",
          "synchronizerId"
        ]

    ListCredentialsResponse:
      type: object
      description: "The response for listing credential records."
      properties:
        credentials:
          type: array
          items:
            $ref: "#/components/schemas/Credential"
          description: |
            The list of credential records matching the provided filters.
        nextPageToken:
          type: string
          description: |
            The token for the next page of results. Omitted if there are no more results.

    Credential:
      type: object
      description: |
        A credential record stored in the registry.
      properties:
        credentialView:
          type: object
          description: |
            The view computed for the credential with the schema of Splice.Api.Credential.RegistryV1.CredentialView.
        disclosedContract:
          $ref: "#/components/schemas/DisclosedContract"
          description: |
            The disclosed contract information for verifying the credential record using explicit contract disclosure.
      required:
        [
          "credentialView",
        ]

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
