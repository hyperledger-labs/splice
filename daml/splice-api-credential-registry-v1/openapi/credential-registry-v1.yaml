# Copyright (c) 2025 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

openapi: 3.0.0
info:
  title: credential registry off-ledger API
  description: |
    Implemented by credential registries for the purpose of creating, updating,
    and querying credential records.
  version: 1.0.0
paths:

  # TODO: fix the schema validation errors. The current state is meant as a sketch to align on the design.

  # TODO: add info endpoint where one can learn about limits of the registry etc.

  # TODO: consider renaming "CredentialRegistry" to "CredentialFactory" to be consistent with the token standard APIs; and to make the call below less confusing
  /registry/credentials/v1/credential-registry
    post:
      operationId: "getCredentialRegistry"
      description: |
        Get the credential registry contract and the choice context for updating records.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GetCredentialRegistryRequest"
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CredentialsRegistryWithChoiceContext"
        "400":
          $ref: "#/components/responses/400"
        "404":
          $ref: "#/components/responses/404"


  /registry/credentials/v1/credentials
    get:
      operationId: "listCredentials"
      description: |
        List the credential records matching the provided filters.

        Note that registries MAY decide to limit the number of records returned.

        Decentralized registries MAY also store a record_time cutoff in the page token to make the
        responses more stable from a pagination perspective.
      parameters:
        - in: query
          name: holder
          schema:
            type: string
          required: false
          description: |
            The party that holds the credential records.
        - in: query
          name: issuer
          schema:
            type: string
          required: false
          description: |
            The party that issued the credential records.
        - in: query
          name: keyPrefix
          schema:
            type: string
          required: false
          description: |
            The prefix of the keys of the credential records.
        - in: query
          name: limit
          schema:
            type: integer
            format: int32
          required: false
          description: |
            The maximum number of credential records to return.
         - in: query
           name: pageToken
           schema:
             type: string
           required: false
           description: |
             The token for the page to retrieve.
        - in: query
          name: validAsOf
          schema:
            type: string
            format: date-time
          required: false
          description: |
            If provided, only return credential records that are valid at the given time.

            TODO: consider whether we can use a `validAsOf` date that is
            slightly in the past to implement stable pagination for
            decentralized registries.

        - in: query
          name: includeDisclosedContracts
          schema:
            type: boolean
            default: false
          required: false
          description: |
            If set to true, the response will include the disclosed contracts of the credentials
            for use with explicit contract disclosure upon command submission.
        - in: query
          name: excludeDebugFields
          schema:
            type: boolean
            default: false
          required: false
          description: |
            If set to true, then the disclosed contracts will not include debug fields.

    responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                type: object
                properties:
                  credentials:
                    type: array
                    items:
                      $ref: "#/components/schemas/CredentialRecord"
                    description: |
                      The list of credential records matching the provided filters.
                  nextPageToken:
                    type: string
                    description: |
                      The token for the next page of results. Omitted if there are no more results.
        "400":
          $ref: "#/components/responses/400"
        "404":
          $ref: "#/components/responses/404"



components:
  responses:
    "400":
      description: "bad request"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    "404":
      description: "not found"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    GetCredentialRegistryRequest:
      # TODO: fill out

    CredentialRecord:
      type: object
      properties:
        credentialRecordView:
          type: object
          description: |
            The view computed for the credential record with the schema of Splice.Api.Credential.RegistryV1.CredentialRecordView.
        disclosedContract:
          $ref: "#/components/schemas/DisclosedContract"
          description: |
            The disclosed contract information for verifying the credential record using explicit contract disclosure.
      required:
        [
          "credentialRecordView",
        ]

    # Note: intentionally not shared with the other APIs to keep the self-contained, and because not all OpenAPI codegens support such shared definitions.
    DisclosedContract:
      type: object
      properties:
        templateId:
          type: string
        contractId:
          type: string
        createdEventBlob:
          type: string
        synchronizerId:
          description: |
            The synchronizer to which the contract is currently assigned.
            If the contract is in the process of being reassigned, then a "409" response is returned.
          type: string
        debugPackageName:
          description: |
            The name of the Daml package that was used to create the contract.
            Use this data only if you trust the provider, as it might not match the data in the
            `createdEventBlob`.
          type: string
        debugPayload:
          description: |
            The contract arguments that were used to create the contract.
            Use this data only if you trust the provider, as it might not match the data in the
            `createdEventBlob`.
          type: object
        debugCreatedAt:
          description: |
            The ledger effective time at which the contract was created.
            Use this data only if you trust the provider, as it might not match the data in the
            `disclosedContract`.
          type: string
          format: date-time
      required:
        [
          "templateId",
          "contractId",
          "createdEventBlob",
          "synchronizerId"
        ]

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
