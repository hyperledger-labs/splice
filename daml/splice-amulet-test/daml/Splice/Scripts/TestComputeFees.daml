-- Copyright (c) 2024 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

module Splice.Scripts.TestComputeFees where

import DA.Assert
import DA.Time
import DA.TextMap as TextMap
import Daml.Script

import Splice.Scripts.Util

import Splice.Api.Token.MetadataV1
import Splice.Amulet
import Splice.AmuletRules
import Splice.Fees

testScaledHoldingFees: Script ()
testScaledHoldingFees = do
  DefaultAppWithUsers{..} <- setupDefaultAppWithUsers

  let
    holdingFee = 1.0
    initialAmuletPrice = 2.0
    scaledHoldingFee = (holdingFee / initialAmuletPrice)

  Some (amuletRulesCid, amuletRules) <- queryAmuletRulesByKey app.dso

  -- Set holding fee and initial amulet price
  submitMulti [app.dso] [app.dso] $ exerciseCmd amuletRulesCid AmuletRules_SetConfig with
    newConfig = amuletRules.configSchedule.initialValue with
                            transferConfig = amuletRules.configSchedule.initialValue.transferConfig with
                              holdingFee = RatePerRound holdingFee
    baseConfig = amuletRules.configSchedule.initialValue

  advanceToIssuanceWithPrice app initialAmuletPrice
  cid <- tap app alice 100.0
  Some amulet <- queryContractId @Amulet alice.primaryParty cid
  amulet.amount.ratePerRound.rate === scaledHoldingFee

  -- Change amulet price, and advance 3 rounds
  advanceToIssuanceWithPrice app 10.0

  -- Alice's amulets were merged in the process, get the new one (which should still have a holding fee based on the old fee and amulet price)
  [(curAmuletCid, curAmulet)] <- queryFilter @Amulet alice.primaryParty (\c -> c.owner == alice.primaryParty)
  curAmulet.amount.ratePerRound.rate === scaledHoldingFee

  -- skip 202 rounds so that the amulet expires
  skipNRounds app 202
  -- advance external party config state contracts to current
  -- rounds
  updateExternalPartyConfigState app
  passTime (hours 24)
  updateExternalPartyConfigState app

  (config0Cid, config1Cid) <- getExternalPartyConfigStates app
  result <- submit app.dso $ exerciseCmd curAmuletCid Amulet_ExpireV2 with
    externalPartyConfigState0Cid = config0Cid
    externalPartyConfigState1Cid = config1Cid

  -- Check the expire result. In particular, actual holding fee should be based
  -- on the amulet price when the amulet was created, not the current one.
  let expectedSummary= AmuletExpireSummary with
        owner = alice.primaryParty
        round = curAmulet.amount.createdAt
        changeToInitialAmountAsOfRoundZero = negate (getValueAsOfRound0 curAmulet.amount)
        changeToHoldingFeesRate = negate scaledHoldingFee
      expectedMeta = Metadata $ TextMap.fromList
        [ ("splice.lfdecentralizedtrust.org/burned", show curAmulet.amount.initialAmount)
        , ("splice.lfdecentralizedtrust.org/tx-kind","expire-dust")
        ]
  expectedSummary === result.expireSum
  expectedMeta === result.meta

  pure ()
