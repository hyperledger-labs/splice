name: "Save Precompiled Classes"
description: "Saves the precompiled classes to the cache"
inputs:
  cache_version:
    description: "Version of the cache"
    required: true
  splice_root:
    description: "Path to splice repo"
    default: ${{ github.repository == 'hyperledger-labs/splice' && '.' || 'splice' }}
  load_cache_hit:
    description: "Cache hit from the load precompiled classes job (should be the cache_hit output from the load precompiled classes job)"
    required: true

runs:
  using: "composite"
  steps:
    - name: Archive precompiled classes
      if: ${{ ! fromJson(inputs.load_cache_hit) }}
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p /tmp/classes
        # We cache */target/scala/* files and */target/streams/* which
        # includes everything that is required for SBT to do fast rebuilds
        # while avoiding issues arising from caching typescript, daml files or anything else.
        find ${{ inputs.splice_root }} -type f -a \( -path '*/target/scala*' -o -path '*/target/streams/*' \) | tar --use-compress-program=pigz -cf /tmp/classes/classes.tar.gz --exclude-vcs -T -

    - name: Not archiving preceompiled classes
      if: ${{ fromJson(inputs.load_cache_hit) }}
      shell: bash
      run: |
        echo "Skipping precompiled classes cache, as there was a cache hit"
    - name: Cache precompiled classes
      if: ${{ ! fromJson(inputs.load_cache_hit) }}
      uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      with:
        path: /tmp/classes
        key: classes-${{ inputs.cache_version }} branch:${{ github.head_ref || github.ref_name }} dependencies:${{ hashFiles(format('{0}/project/build.properties', inputs.splice_root), format('{0}/project/BuildCommon.scala', inputs.splice_root), format('{0}/project/DamlPlugin.scala', inputs.splice_root), format('{0}/project/Dependencies.scala', inputs.splice_root), format('{0}/project/CantonDependencies.scala', inputs.splice_root), format('{0}/project/Houserules.scala', inputs.splice_root), format('{0}/project/plugins.sbt', inputs.splice_root), format('{0}/build.sbt', inputs.splice_root), format('{0}/daml/dars.lock', inputs.splice_root), format('{0}/openapi-cache-key.txt', inputs.splice_root)) }} rev:${{ github.sha }}
