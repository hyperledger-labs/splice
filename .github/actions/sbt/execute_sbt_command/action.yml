name: "Execute SBT command"
description: "A context within which SBT commands can be run correctly for our needs"

inputs:
  cmd:
    # This may contain several commands.
    # The caller needs to quote commands that contain spaces, e.g. "\"testOnly myTest\"".
    description: "The SBT command to run"
    required: true
  artifactory_user:
    description: "Artifactory user"
    required: false
  artifactory_password:
    description: "Artifactory password"
    required: false
  extra_env_vars:
    description: "Extra environment variables to set before running the SBT command"
    required: false
    default: ""
  extra_parameters:
    description: "Extra parameters to pass to SBT"
    required: false
    default: ""
  pre_sbt_cmd:
    description: "Extra command to run before running the SBT command"
    required: false
    default: ""
  post_sbt_cmd:
    description: "Extra command to run after running the SBT command"
    required: false
    default: ""
  timeout:
    description: "Timeout for the SBT command"
    required: false
    default: "40m"
  additional_nix_args:
    description: "Additional arguments to pass to the Nix command"
    required: false
    default: ""
  fail_on_error_in_output:
    description: "Whether to fail if the SBT command output contains errors"
    required: false
    default: "true"
  splice_root:
    description: "Path to splice repo"
    default: ${{ github.repository == 'hyperledger-labs/splice' && '.' || 'splice' }}

runs:
  using: 'composite'
  steps:
    - name: Execute SBT command"
      uses: ./.github/actions/nix/run_bash_command_in_nix
      with:
        additional_nix_args: "--keep GITHUB_ACTION_PATH --keep ARTIFACTORY_USER --keep ARTIFACTORY_PASSWORD ${{ inputs.additional_nix_args }}"
        cmd: |
            # This might help resolve https://github.com/DACH-NY/canton-network-node/issues/8146
            export PROTOCBRIDGE_NO_CLEANUP="1"
            # just set tmpdir to a place where we can write and execute, to fix protoc execution issue: https://github.com/DACH-NY/cn-test-failures/issues/5129
            mkdir -p "${HOME}/tmp"
            ABS_TMP_DIR="${HOME}/tmp"
            export SBT_OPTS="${SBT_OPTS} -Djava.io.tmpdir=${ABS_TMP_DIR}"

            run_sbt() {
              export ${{ inputs.extra_env_vars }}
              # Define sbt command
              SBT_CMD=(sbt)

              # Add extra parameters
              SBT_CMD+=(${{ inputs.extra_parameters }})

              # Add sbt commands.
              # Do not quote this, to allow the caller to pass in several commands.
              # The caller needs to take care of quoting, if a command contains spaces.
              SBT_CMD+=(${{ inputs.cmd }})

              # Run command
              timeout --kill-after=30s ${{ inputs.timeout }} "${SBT_CMD[@]}" 2>&1 | tee sbt_output || status=$?
              if [ -n "${status:-}" ]; then
                if [ $status = 124 ]; then
                  echo "Killed SBT after timeout ${{ inputs.timeout }}"
                fi
                exit $status
              fi

              echo "After SBT"

              if [[ "${{ inputs.fail_on_error_in_output }}" == "true" ]]; then
                # Note that we're using GITHUB_ACTION_PATH 
                # because of a GHA bug - using ${{ github.action_path }} won't work
                # https://github.com/actions/runner/issues/2185#issuecomment-1750670864
                $GITHUB_ACTION_PATH/../../scripts/check-sbt-output.sh "sbt_output"
              fi
            }
            export ARTIFACTORY_USER="${{ inputs.artifactory_user }}"
            export ARTIFACTORY_PASSWORD="${{ inputs.artifactory_password }}"

            # Ensure that we're in the root of splice before execution
            pushd ${{ inputs.splice_root }} &> /dev/null

            ${{ inputs.pre_sbt_cmd }}
            run_sbt
            ${{ inputs.post_sbt_cmd }}

            # Move back to the original directory
            # || true because if we did a pushd . before the stack is considered to be empty
            popd &> /dev/null || true
