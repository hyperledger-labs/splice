name: test
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test:
    runs-on: ubuntu-24.04
    steps:
      - name: Get Egress IP Address
        id: get_ip
        run: |
          # Use a service to get the public IP of the runner
          EGRESS_IP=$(curl -s https://icanhazip.com)
          echo "Egress IP: $EGRESS_IP"
          # Set the IP as a step output
          echo "ip=$EGRESS_IP" >> $GITHUB_OUTPUT

      - name: Use Egress IP to Guess Region
        if: steps.get_ip.outputs.ip != ''
        id: get_location
        run: |
          IP_TO_CHECK="${{ steps.get_ip.outputs.ip }}"
          echo "Checking IP: $IP_TO_CHECK"
          # Use a service to get the location of the IP
          # You can use a dedicated service or a cloud provider's public IP list
          # Example with an external API (for demonstration)
          # Note: This is an external API call and may be rate-limited
          LOCATION_INFO=$(curl -s "https://ipinfo.io/$IP_TO_CHECK/json")
          CITY=$(echo "$LOCATION_INFO" | jq -r '.city')
          REGION=$(echo "$LOCATION_INFO" | jq -r '.region')
          COUNTRY=$(echo "$LOCATION_INFO" | jq -r '.country')
          ORG=$(echo "$LOCATION_INFO" | jq -r '.org')

          echo "Location Info: $CITY, $REGION, $COUNTRY"
          echo "Organization: $ORG"

          # Use a simple conditional to guess the cloud provider and region
          if [[ "$ORG" == *"Microsoft"* ]]; then
            echo "The runner is hosted on Microsoft Azure."
            if [[ "$REGION" == "Virginia" ]]; then
              echo "The runner is likely in an East US region."
            elif [[ "$REGION" == "California" ]]; then
              echo "The runner is likely in a West US region."
            fi
          fi

      - name: direct test
        shell: bash
        run: |
          curl https://storage.googleapis.com/splice-nix-cache-public/48461acabd81ff985f7de6e4a32efb29.tar.gz -o b.tar.gz

      - name: test via CDN
        shell: bash
        run: |
          curl 34.111.229.14/48461acabd81ff985f7de6e4a32efb29.tar.gz -o a.tar.gz
